# Traefik 动态配置 - 微服务路由
# ResearchGO API Gateway

http:
  # ============ 路由规则 ============
  routers:
    # Agent 服务 (核心)
    agent-router:
      rule: "PathPrefix(`/api/agent`)"
      service: agent-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 认证服务
    auth-router:
      rule: "PathPrefix(`/api/auth`)"
      service: auth-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 对话服务
    conversation-router:
      rule: "PathPrefix(`/api/conversations`)"
      service: conversation-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 论文存储服务
    paper-router:
      rule: "PathPrefix(`/api/papers`)"
      service: paper-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 向量搜索服务
    vector-router:
      rule: "PathPrefix(`/api/vector`)"
      service: vector-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # Milvus 管理路由
    milvus-router:
      rule: "PathPrefix(`/api/milvus`)"
      service: vector-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 文献检索服务
    literature-router:
      rule: "PathPrefix(`/api/literature`)"
      service: literature-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 思维导图服务
    mindmap-router:
      rule: "PathPrefix(`/api/mindmap`)"
      service: mindmap-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

    # 分析服务
    analysis-router:
      rule: "PathPrefix(`/api/analysis`)"
      service: analysis-service
      entryPoints:
        - web
      middlewares:
        - cors-headers

  # ============ 服务定义 ============
  # Docker Compose 网络内使用服务名访问
  services:
    agent-service:
      loadBalancer:
        servers:
          - url: "http://agent-service:8000"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    auth-service:
      loadBalancer:
        servers:
          - url: "http://auth-service:8001"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    conversation-service:
      loadBalancer:
        servers:
          - url: "http://conversation-service:8002"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    paper-service:
      loadBalancer:
        servers:
          - url: "http://paper-storage-service:8003"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    vector-service:
      loadBalancer:
        servers:
          - url: "http://vector-search-service:8004"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    literature-service:
      loadBalancer:
        servers:
          - url: "http://literature-search-service:8005"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    mindmap-service:
      loadBalancer:
        servers:
          - url: "http://mindmap-service:8007"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

    analysis-service:
      loadBalancer:
        servers:
          - url: "http://analysis-service:8008"
        healthCheck:
          path: /health
          interval: "10s"
          timeout: "3s"

  # ============ 中间件 ============
  middlewares:
    # CORS 配置
    cors-headers:
      headers:
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
          - "PATCH"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Requested-With"
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 3600
        addVaryHeader: true

    # 限流配置
    rate-limit:
      rateLimit:
        average: 100
        burst: 50

    # 重试配置
    retry:
      retry:
        attempts: 3
        initialInterval: "100ms"
