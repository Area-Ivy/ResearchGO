# ResearchGO RAG ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## æ¦‚è¿°

ResearchGO çš„ RAGï¼ˆRetrieval-Augmented Generationï¼‰ç³»ç»Ÿæ˜¯ä¸€ä¸ª**æ··åˆæ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿ**ï¼Œä¸“ä¸ºå­¦æœ¯è®ºæ–‡é—®ç­”åœºæ™¯è®¾è®¡ã€‚ç³»ç»Ÿç»“åˆäº†ç¨ å¯†å‘é‡æ£€ç´¢ï¼ˆDense Retrievalï¼‰ã€ç¨€ç–å…³é”®è¯æ£€ç´¢ï¼ˆSparse Retrievalï¼‰ã€ç¥ç»ç½‘ç»œé‡æ’åºï¼ˆNeural Rerankingï¼‰å’Œ**è·¨è¯­è¨€æŸ¥è¯¢ç¿»è¯‘ï¼ˆCross-lingual Query Translationï¼‰**ï¼Œå®ç°é«˜è´¨é‡çš„æ–‡æ¡£æ£€ç´¢å’Œæ™ºèƒ½é—®ç­”ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ··åˆæ£€ç´¢**: Dense (Embedding) + Sparse (BM25)
- âœ… **æ™ºèƒ½èåˆ**: RRF (Reciprocal Rank Fusion)
- âœ… **ç²¾å‡†é‡æ’**: Cross-Encoder Reranker
- âœ… **è·¨è¯­è¨€æ£€ç´¢**: ä¸­æ–‡æŸ¥è¯¢ â†” è‹±æ–‡è®ºæ–‡

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ResearchGO RAG System                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         1. æ–‡æ¡£å¤„ç†å±‚ (Indexing)                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  PDF     â”‚ â†’  â”‚  æ–‡æœ¬    â”‚ â†’  â”‚  Chunk   â”‚ â†’  â”‚  åŒç´¢å¼•å­˜å‚¨      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ä¸Šä¼     â”‚    â”‚  æå–    â”‚    â”‚  åˆ‡åˆ†    â”‚    â”‚  (Milvus+BM25)   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         2. æ£€ç´¢å±‚ (Retrieval)                           â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚    Query(ä¸­æ–‡) â”€â”€â–º è¯­è¨€æ£€æµ‹ â”€â”€â–º GPTç¿»è¯‘ â”€â”€â–º Query(è‹±æ–‡)                â”‚   â”‚
â”‚  â”‚                                                  â”‚                      â”‚   â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚                    â”‚                             â”‚           â”‚          â”‚   â”‚
â”‚  â”‚                    â–¼                             â–¼           â”‚          â”‚   â”‚
â”‚  â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚          â”‚   â”‚
â”‚  â”‚             â”‚ Dense Search â”‚             â”‚Sparse Search â”‚    â”‚          â”‚   â”‚
â”‚  â”‚             â”‚  (Embedding) â”‚             â”‚   (BM25)     â”‚    â”‚          â”‚   â”‚
â”‚  â”‚             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚          â”‚   â”‚
â”‚  â”‚                    â”‚                            â”‚            â”‚          â”‚   â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚          â”‚   â”‚
â”‚  â”‚                                 â–¼                            â”‚          â”‚   â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚          â”‚   â”‚
â”‚  â”‚                        â”‚   RRF Fusion     â”‚                  â”‚          â”‚   â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚          â”‚   â”‚
â”‚  â”‚                                 â–¼                            â”‚          â”‚   â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚          â”‚   â”‚
â”‚  â”‚                        â”‚ Cross-Encoder    â”‚                  â”‚          â”‚   â”‚
â”‚  â”‚                        â”‚   Reranker       â”‚                  â”‚          â”‚   â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚          â”‚   â”‚
â”‚  â”‚                                 â”‚                            â”‚          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                 â–¼          3. ç”Ÿæˆå±‚ (Generation)        â”‚   â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚  â”‚                        â”‚  Context Builder â”‚                              â”‚   â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚  â”‚                                 â–¼                                        â”‚   â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚  â”‚                        â”‚    LLM (GPT-4)   â”‚                              â”‚   â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚  â”‚                                 â–¼                                        â”‚   â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚  â”‚                        â”‚  Answer + Refs   â”‚                              â”‚   â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

### 1. æ–‡æ¡£å¤„ç†å±‚

#### 1.1 PDF æ–‡æœ¬æå–

ä½¿ç”¨ **pdfplumber** è¿›è¡Œ PDF æ–‡æœ¬æå–ï¼š

```python
async def extract_text_from_pdf(pdf_data: bytes, max_pages: int = 50) -> str:
    with pdfplumber.open(pdf_stream) as pdf:
        for page in pdf.pages[:max_pages]:
            text = page.extract_text()
            text_content.append(f"--- Page {i+1} ---\n{text}")
    return "\n\n".join(text_content)
```

#### 1.2 LLM ç»“æ„åŒ–è§£æ

ä½¿ç”¨ **GPT-4** æå–è®ºæ–‡çš„ç»“æ„åŒ–ä¿¡æ¯ï¼š

```python
class PaperStructure:
    title: str              # è®ºæ–‡æ ‡é¢˜
    authors: List[str]      # ä½œè€…åˆ—è¡¨
    abstract: str           # æ‘˜è¦
    sections: List[PaperSection]  # ç« èŠ‚åˆ—è¡¨
    references_count: int   # å‚è€ƒæ–‡çŒ®æ•°é‡

class PaperSection:
    section_type: str       # abstract/introduction/methods/results/discussion/conclusion/other
    section_title: str      # ç« èŠ‚æ ‡é¢˜
    content: str            # ç« èŠ‚å†…å®¹
    subsections: List[PaperSection]  # å­ç« èŠ‚
```

**LLM è§£ææµç¨‹ï¼š**
```
PDF åŸå§‹æ–‡æœ¬
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GPT-4 ç»“æ„åŒ–è§£æ          â”‚
â”‚   (response_format: json)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
PaperStructure {
  title, authors, abstract,
  sections: [
    {type: "introduction", title: "1. Introduction", content: "..."},
    {type: "methods", title: "2. Methods", content: "...", subsections: [
      {type: "methods", title: "2.1 Data Collection", content: "..."},
      {type: "methods", title: "2.2 Model Architecture", content: "..."}
    ]},
    ...
  ]
}
```

#### 1.3 é€’å½’è¯­ä¹‰åˆ‡åˆ† (Recursive Semantic Chunking)

åœ¨ç»“æ„åŒ–è§£æçš„åŸºç¡€ä¸Šï¼Œå¯¹æ¯ä¸ªç« èŠ‚è¿›è¡Œé€’å½’è¯­ä¹‰åˆ‡åˆ†ï¼š

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| max_chunk_size | 1000 å­—ç¬¦ | æ¯ä¸ª chunk çš„æœ€å¤§é•¿åº¦ |
| min_chunk_size | 100 å­—ç¬¦ | æœ€å° chunk å¤§å° |
| chunk_overlap | 100 å­—ç¬¦ | ç›¸é‚» chunk çš„é‡å éƒ¨åˆ† |

**é€’å½’åˆ‡åˆ†ç­–ç•¥ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š**
1. æ®µè½åˆ†éš”ç¬¦ (`\n\n`)
2. è¡Œåˆ†éš”ç¬¦ (`\n`)
3. å¥å­ç»“æŸç¬¦ - ä¸­æ–‡ (`ã€‚ï¼ï¼Ÿ`)
4. å¥å­ç»“æŸç¬¦ - è‹±æ–‡ (`. ! ?`)
5. åˆ†å¥ç¬¦ (`ï¼›;`)
6. é€—å· (`ï¼Œ,`)
7. ç©ºæ ¼
8. ç¡¬åˆ‡åˆ†ï¼ˆæœ€åæ‰‹æ®µï¼‰

```python
class StructuredChunk:
    content: str                # æ–‡æœ¬å†…å®¹
    chunk_index: int            # chunk ç´¢å¼•
    section_type: str           # ç« èŠ‚ç±»å‹
    section_title: str          # ç« èŠ‚æ ‡é¢˜
    subsection_title: str       # å­ç« èŠ‚æ ‡é¢˜
    hierarchy_path: str         # å±‚çº§è·¯å¾„ "Methods > Data Collection"
    is_complete_section: bool   # æ˜¯å¦å®Œæ•´ç« èŠ‚ï¼ˆæœªè¢«åˆ‡åˆ†ï¼‰
```

**æµç¨‹ç¤ºæ„ï¼š**
```
PaperStructure
     â”‚
     â”œâ”€â”€ Abstract (800 chars) â†’ 1 chunk (å®Œæ•´)
     â”‚
     â”œâ”€â”€ Introduction (2500 chars)
     â”‚       â”‚
     â”‚       â””â”€â”€ é€’å½’åˆ‡åˆ† â†’ 3 chunks
     â”‚
     â”œâ”€â”€ Methods (5000 chars)
     â”‚       â”‚
     â”‚       â”œâ”€â”€ 2.1 Data (1500 chars) â†’ 2 chunks
     â”‚       â””â”€â”€ 2.2 Model (2000 chars) â†’ 2 chunks
     â”‚
     â””â”€â”€ ... 
```

#### 1.4 åŒç´¢å¼•å­˜å‚¨

æ¯ä¸ªç»“æ„åŒ– chunk åŒæ—¶å­˜å‚¨åˆ°ä¸¤ä¸ªç´¢å¼•ï¼š

| ç´¢å¼•ç±»å‹ | å­˜å‚¨ | ç”¨é€” |
|----------|------|------|
| **Milvus** (ç¨ å¯†) | 1536 ç»´å‘é‡ + å…ƒæ•°æ® | è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ |
| **BM25** (ç¨€ç–) | åˆ†è¯åçš„ token + å…ƒæ•°æ® | å…³é”®è¯ç²¾ç¡®åŒ¹é… |

**Milvus å­—æ®µæ˜ å°„ï¼ˆå¤ç”¨ç°æœ‰ Schemaï¼‰ï¼š**

| å­—æ®µ | å­˜å‚¨å†…å®¹ | è¯´æ˜ |
|------|----------|------|
| `source` | section_type | ç« èŠ‚ç±»å‹ (abstract/introduction/methods/...) |
| `page_range` | hierarchy_path | å±‚çº§è·¯å¾„ (Methods > Data Collection) |
| `content` | chunk.content | æ–‡æœ¬å†…å®¹ |
| `chunk_index` | chunk.chunk_index | åœ¨è®ºæ–‡ä¸­çš„åºå· |

**æ£€ç´¢æ—¶å¯æŒ‰ç« èŠ‚è¿‡æ»¤ï¼š**
```python
# åªæœç´¢ Methods éƒ¨åˆ†
filter_expr = 'source == "methods"'

# æœç´¢ Introduction æˆ– Conclusion
filter_expr = 'source in ["introduction", "conclusion"]'
```

---

### 2. æ£€ç´¢å±‚

#### 2.0 Query Translation (è·¨è¯­è¨€æŸ¥è¯¢ç¿»è¯‘)

**é—®é¢˜èƒŒæ™¯ï¼š**
å­¦æœ¯è®ºæ–‡é€šå¸¸æ˜¯è‹±æ–‡ï¼Œä½†ç”¨æˆ·å¯èƒ½ä½¿ç”¨ä¸­æ–‡æé—®ã€‚BM25 åŸºäºå…³é”®è¯åŒ¹é…ï¼Œä¸­æ–‡æŸ¥è¯¢æ— æ³•åŒ¹é…è‹±æ–‡è®ºæ–‡ä¸­çš„å…³é”®è¯ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```python
def detect_language(self, text: str) -> str:
    """æ£€æµ‹æ–‡æœ¬è¯­è¨€"""
    chinese_pattern = re.compile(r'[\u4e00-\u9fff]')
    chinese_chars = len(chinese_pattern.findall(text))
    chinese_ratio = chinese_chars / len(text.strip())
    
    if chinese_ratio > 0.3:
        return 'zh'
    elif chinese_ratio < 0.1:
        return 'en'
    else:
        return 'mixed'

async def translate_query(self, query: str, target_language: str = 'en'):
    """ä½¿ç”¨ GPT ç¿»è¯‘æŸ¥è¯¢"""
    source_lang = self.detect_language(query)
    
    if source_lang == target_language:
        return query, False  # æ— éœ€ç¿»è¯‘
    
    system_prompt = """You are a professional translator for academic queries.
Translate the following Chinese query to English.
Keep academic terms accurate and natural.
Only output the translation, nothing else."""
    
    translated = await self.client.chat.completions.create(
        model="gpt-4o-mini",  # ä½¿ç”¨è½»é‡æ¨¡å‹æé«˜é€Ÿåº¦
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": query}
        ],
        temperature=0.3
    )
    return translated, True
```

**æ£€ç´¢æµç¨‹ä¸­çš„ç¿»è¯‘ç­–ç•¥ï¼š**

| æ£€ç´¢ç±»å‹ | ä½¿ç”¨çš„æŸ¥è¯¢ | åŸå›  |
|----------|-----------|------|
| Dense Search | ç¿»è¯‘åæŸ¥è¯¢ | åŒè¯­è¨€ embedding åŒ¹é…æ›´ç²¾å‡† |
| BM25 Search | ç¿»è¯‘åæŸ¥è¯¢ | å…³é”®è¯åŒ¹é…éœ€è¦è¯­è¨€å¯¹é½ |

**ç¤ºä¾‹ï¼š**
```
åŸå§‹æŸ¥è¯¢ (ä¸­æ–‡): "å¤§è¯­è¨€æ¨¡å‹çš„æ³¨æ„åŠ›æœºåˆ¶æ˜¯ä»€ä¹ˆ"
ç¿»è¯‘å (è‹±æ–‡):   "What is the attention mechanism of large language models"

Dense Search â†’ ä½¿ç”¨ç¿»è¯‘åè‹±æ–‡æŸ¥è¯¢ï¼Œä¸è‹±æ–‡è®ºæ–‡ embedding ç²¾ç¡®åŒ¹é…
BM25 Search  â†’ ä½¿ç”¨ç¿»è¯‘åè‹±æ–‡æŸ¥è¯¢ï¼ŒåŒ¹é… "attention", "mechanism", "large language models"
```

> ğŸ’¡ **è®¾è®¡å†³ç­–**ï¼šè™½ç„¶ OpenAI embedding æ¨¡å‹æ”¯æŒå¤šè¯­è¨€ï¼Œä½†åŒè¯­è¨€çš„åŒ¹é…é€šå¸¸æ›´ç²¾å‡†ã€‚ç»Ÿä¸€ä½¿ç”¨ç¿»è¯‘åçš„æŸ¥è¯¢ä¹Ÿè®©ç³»ç»Ÿæ›´ç®€æ´ã€‚

#### 2.1 Dense Search (ç¨ å¯†å‘é‡æ£€ç´¢)

**æŠ€æœ¯æ ˆï¼š**
- Embedding: OpenAI `text-embedding-ada-002` (1536 ç»´)
- å‘é‡æ•°æ®åº“: Milvus
- ç´¢å¼•ç±»å‹: IVF_FLAT
- è·ç¦»åº¦é‡: L2 (æ¬§æ°è·ç¦»)

**ç´¢å¼•å‚æ•°ï¼š**
```python
index_params = {
    "metric_type": "L2",
    "index_type": "IVF_FLAT",
    "params": {"nlist": 1024}  # èšç±»æ•°é‡
}
```

**æœç´¢å‚æ•°ï¼š**
```python
search_params = {
    "metric_type": "L2",
    "params": {"nprobe": 10}  # æ¢æµ‹èšç±»æ•°
}
```

**ç›¸å…³æ€§åˆ†æ•°è®¡ç®—ï¼š**
```python
relevance_score = 1 / (1 + distance)  # è·ç¦»è¶Šå°ï¼Œåˆ†æ•°è¶Šé«˜
```

#### 2.2 Sparse Search (ç¨€ç–å…³é”®è¯æ£€ç´¢)

**æŠ€æœ¯æ ˆï¼š**
- ç®—æ³•: BM25 (Okapi BM25)
- åˆ†è¯: jieba (æ”¯æŒä¸­è‹±æ–‡)
- å®ç°: rank_bm25 åº“

**BM25 å…¬å¼ï¼š**
```
score(D, Q) = Î£ IDF(qi) Â· (f(qi, D) Â· (k1 + 1)) / (f(qi, D) + k1 Â· (1 - b + b Â· |D|/avgdl))
```

**åˆ†è¯å¤„ç†ï¼š**
```python
def tokenize(self, text: str) -> List[str]:
    text = text.lower()
    text = re.sub(r'[^\w\s\u4e00-\u9fff]', ' ', text)
    tokens = list(jieba.cut(text))
    tokens = [t.strip() for t in tokens if len(t.strip()) > 1]
    return tokens
```

#### 2.3 RRF Fusion (å€’æ•°æ’åèåˆ)

**ç®—æ³•ï¼šReciprocal Rank Fusion**

å°†å¤šä¸ªæ£€ç´¢ç»“æœåˆ—è¡¨èåˆä¸ºä¸€ä¸ªï¼š

```python
def reciprocal_rank_fusion(result_lists, k=60, id_field="chunk_id"):
    rrf_scores = defaultdict(float)
    
    for results in result_lists:
        for rank, doc in enumerate(results):
            doc_id = doc.get(id_field)
            # RRF å…¬å¼
            rrf_scores[doc_id] += 1.0 / (k + rank + 1)
    
    # æŒ‰ RRF åˆ†æ•°æ’åº
    sorted_ids = sorted(rrf_scores.keys(), key=lambda x: rrf_scores[x], reverse=True)
    return sorted_ids
```

**RRF å…¬å¼ï¼š**
```
RRF(d) = Î£ 1 / (k + rank_i(d))
```

å…¶ä¸­ `k` æ˜¯å¸¸æ•°ï¼ˆé»˜è®¤ 60ï¼‰ï¼Œ`rank_i(d)` æ˜¯æ–‡æ¡£ d åœ¨ç¬¬ i ä¸ªåˆ—è¡¨ä¸­çš„æ’åã€‚

**RRF ä¼˜åŠ¿ï¼š**
- æ— éœ€å½’ä¸€åŒ–ä¸åŒæ£€ç´¢ç³»ç»Ÿçš„åˆ†æ•°
- å¯¹å¼‚å¸¸å€¼ä¸æ•æ„Ÿ
- ç®€å•é«˜æ•ˆ

#### 2.4 Cross-Encoder Reranker

**æŠ€æœ¯æ ˆï¼š**
- æ¨¡å‹: BGE-Reranker-Base (BAAI)
- æ¡†æ¶: sentence-transformers

**å·¥ä½œåŸç†ï¼š**
```
Query + Document â†’ [CLS] Query [SEP] Document [SEP] â†’ Cross-Encoder â†’ Score
```

ä¸ Bi-Encoder (ç”¨äºåˆå§‹æ£€ç´¢) ä¸åŒï¼ŒCross-Encoder åŒæ—¶è€ƒè™‘ Query å’Œ Documentï¼Œèƒ½æ›´ç²¾ç¡®åœ°è¯„ä¼°ç›¸å…³æ€§ã€‚

```python
def rerank(self, query: str, documents: List[Dict], top_k: int):
    # æ„å»º query-document pairs
    pairs = [[query, doc['content']] for doc in documents]
    
    # è®¡ç®— Cross-Encoder åˆ†æ•°
    scores = self.model.predict(pairs)
    
    # æŒ‰åˆ†æ•°æ’åº
    sorted_docs = sorted(zip(documents, scores), key=lambda x: x[1], reverse=True)
    return sorted_docs[:top_k]
```

---

### 3. ç”Ÿæˆå±‚

#### 3.1 Context æ„å»º

å°†æ£€ç´¢åˆ°çš„ Top-K chunks æ„å»ºä¸º LLM çš„ä¸Šä¸‹æ–‡ï¼š

```python
context_parts = []
for i, chunk in enumerate(top_k_results, 1):
    context_parts.append(f"ã€ç‰‡æ®µ {i}ã€‘(é¡µç : {chunk['page_range']})\n{chunk['content']}\n")
context = "\n".join(context_parts)
```

#### 3.2 Prompt æ¨¡æ¿

```python
system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£å’Œåˆ†æç ”ç©¶è®ºæ–‡ã€‚

åŸºäºæä¾›çš„è®ºæ–‡å†…å®¹ç‰‡æ®µï¼Œè¯·å‡†ç¡®ã€è¯¦ç»†åœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚

æ³¨æ„äº‹é¡¹ï¼š
1. åªåŸºäºæä¾›çš„ä¸Šä¸‹æ–‡å›ç­”ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯
2. å¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·
3. å›ç­”è¦ä¸“ä¸šã€å‡†ç¡®ã€æœ‰æ¡ç†
4. å¿…è¦æ—¶å¯ä»¥å¼•ç”¨åŸæ–‡
5. ä½¿ç”¨ä¸­æ–‡å›ç­”"""

user_prompt = f"""å‚è€ƒå†…å®¹ï¼š
{context}

é—®é¢˜ï¼š{question}

è¯·åŸºäºä»¥ä¸Šå‚è€ƒå†…å®¹å›ç­”é—®é¢˜ã€‚"""
```

#### 3.3 LLM è°ƒç”¨

æ”¯æŒæµå¼å’Œéæµå¼ä¸¤ç§æ¨¡å¼ï¼š

| æ¨¡å¼ | API | ç”¨é€” |
|------|-----|------|
| éæµå¼ | `POST /api/vector/qa` | ç®€å•é—®ç­” |
| æµå¼ | `POST /api/vector/qa-stream` | å®æ—¶äº¤äº’ |

---

## API æ¥å£

### æ£€ç´¢ API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/vector/search` | POST | çº¯å‘é‡è¯­ä¹‰æœç´¢ |
| `/api/vector/hybrid-search` | POST | æ··åˆæ£€ç´¢ (å‘é‡+BM25+Reranker+Queryç¿»è¯‘) |

**æ··åˆæ£€ç´¢å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| query | string | å¿…å¡« | æŸ¥è¯¢æ–‡æœ¬ï¼ˆæ”¯æŒä¸­/è‹±æ–‡ï¼‰ |
| top_k | int | 10 | è¿”å›æ•°é‡ |
| paper_id | string | null | é™å®šè®ºæ–‡ID |
| use_reranker | bool | true | æ˜¯å¦ä½¿ç”¨ Reranker |
| translate_query | bool | true | æ˜¯å¦å¯ç”¨è·¨è¯­è¨€ç¿»è¯‘ |

### é—®ç­” API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/vector/qa` | POST | è®ºæ–‡é—®ç­”ï¼ˆéæµå¼ï¼‰ |
| `/api/vector/qa-stream` | POST | è®ºæ–‡é—®ç­”ï¼ˆæµå¼ SSEï¼‰ |
| `/api/vector/hybrid-qa` | POST | æ··åˆæ£€ç´¢é—®ç­”ï¼ˆæ”¯æŒè·¨è¯­è¨€ï¼‰ |

### ç´¢å¼•ç®¡ç† API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/vector/index` | POST | ç´¢å¼•è®ºæ–‡ |
| `/api/vector/delete/{paper_id}` | DELETE | åˆ é™¤è®ºæ–‡ç´¢å¼• |
| `/api/vector/stats` | GET | è·å–ç´¢å¼•ç»Ÿè®¡ |

---

## æ•°æ®æµ

### ç´¢å¼•æµç¨‹

```
PDF ä¸Šä¼ 
    â”‚
    â–¼
paper-storage-service
    â”‚
    â”œâ”€â”€â–º MinIO (å­˜å‚¨ PDF æ–‡ä»¶)
    â”‚
    â”œâ”€â”€â–º MySQL (å­˜å‚¨å…ƒä¿¡æ¯)
    â”‚
    â””â”€â”€â–º ç»“æ„åŒ–è§£ææµç¨‹ (åå°ä»»åŠ¡)
              â”‚
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  1. PDF æ–‡æœ¬æå–        â”‚
         â”‚     (pdfplumber)        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  2. LLM ç»“æ„è§£æ        â”‚
         â”‚     (GPT-4)             â”‚
         â”‚                         â”‚
         â”‚  æå–: æ ‡é¢˜ã€æ‘˜è¦ã€      â”‚
         â”‚  ç« èŠ‚ã€å­ç« èŠ‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  3. é€’å½’è¯­ä¹‰åˆ‡åˆ†        â”‚
         â”‚                         â”‚
         â”‚  æŒ‰ç« èŠ‚ç»“æ„åˆ‡åˆ†,        â”‚
         â”‚  ä¿ç•™è¯­ä¹‰è¾¹ç•Œ           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
         vector-search-service
              â”‚
              â”œâ”€â”€â–º OpenAI Embedding API
              â”‚         â”‚
              â”‚         â–¼
              â”‚    1536 ç»´å‘é‡
              â”‚         â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º Milvus (ç¨ å¯†ç´¢å¼• + section_type)
              â”‚         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º BM25 (ç¨€ç–ç´¢å¼• + hierarchy_path)
                        â”‚
                        â–¼
                   ç»“æ„åŒ–ç´¢å¼•å®Œæˆ
```

### æŸ¥è¯¢æµç¨‹

```
ç”¨æˆ·é—®é¢˜ (å¯èƒ½æ˜¯ä¸­æ–‡)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è¯­è¨€æ£€æµ‹ + ç¿»è¯‘      â”‚  â† æ£€æµ‹åˆ°ä¸­æ–‡åˆ™ç¿»è¯‘ä¸ºè‹±æ–‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç»Ÿä¸€çš„è‹±æ–‡æŸ¥è¯¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                       â”‚                       â”‚
                     â–¼                       â–¼                       â”‚
              OpenAI Embedding          jieba åˆ†è¯                   â”‚
                     â”‚                       â”‚                       â”‚
                     â–¼                       â–¼                       â”‚
              Milvus ANN Search         BM25 Search                  â”‚
                     â”‚                       â”‚                       â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
                                 â”‚                                   â”‚
                                 â–¼                                   â”‚
                          RRF Fusion (k=60)                          â”‚
                                 â”‚                                   â”‚
                                 â–¼                                   â”‚
                      Cross-Encoder Reranker                         â”‚
                                 â”‚                                   â”‚
                                 â–¼                                   â”‚
                          Top-K Documents                            â”‚
                                 â”‚                                   â”‚
                                 â–¼                                   â”‚
                         Context Builder                             â”‚
                                 â”‚                                   â”‚
                                 â–¼                                   â”‚
                          GPT-4 / GPT-3.5                            â”‚
                                 â”‚                                   â”‚
                                 â–¼                                   â”‚
                            AI å›ç­” (ä¸­æ–‡)
```

---

## æ€§èƒ½å‚æ•°

| ç»„ä»¶ | å‚æ•° | å€¼ | è¯´æ˜ |
|------|------|-----|------|
| Dense Search | initial_k | 20 | åˆå§‹æ£€ç´¢æ•°é‡ |
| Sparse Search | initial_k | 20 | åˆå§‹æ£€ç´¢æ•°é‡ |
| RRF | k | 60 | RRF å¸¸æ•° |
| Reranker | final_k | 10 | é‡æ’åºåè¿”å›æ•°é‡ |
| Milvus | nprobe | 10 | æœç´¢æ—¶æ¢æµ‹çš„èšç±»æ•° |
| Milvus | nlist | 1024 | èšç±»æ€»æ•° |

---

## æŠ€æœ¯é€‰å‹ç†ç”±

### ä¸ºä»€ä¹ˆé€‰æ‹© Milvusï¼Ÿ

| ç‰¹æ€§ | Milvus | Pinecone | Faiss |
|------|--------|----------|-------|
| å¼€æº | âœ… | âŒ | âœ… |
| åˆ†å¸ƒå¼ | âœ… | âœ… | âŒ |
| å…ƒæ•°æ®è¿‡æ»¤ | âœ… | âœ… | æœ‰é™ |
| åŠ¨æ€ Schema | âœ… | âŒ | âŒ |
| ç§æœ‰éƒ¨ç½² | âœ… | âŒ | âœ… |

### ä¸ºä»€ä¹ˆé€‰æ‹© BM25 + Dense æ··åˆï¼Ÿ

| åœºæ™¯ | çº¯å‘é‡ | çº¯ BM25 | æ··åˆ |
|------|--------|---------|------|
| è¯­ä¹‰ç›¸ä¼¼ | âœ… ä¼˜ | âŒ å·® | âœ… ä¼˜ |
| ç²¾ç¡®å…³é”®è¯ | âŒ å·® | âœ… ä¼˜ | âœ… ä¼˜ |
| ä¸“ä¸šæœ¯è¯­ | âš ï¸ ä¸€èˆ¬ | âœ… ä¼˜ | âœ… ä¼˜ |
| å¤šè¯­è¨€ | âœ… ä¼˜ | âš ï¸ éœ€åˆ†è¯ | âœ… ä¼˜ |

### ä¸ºä»€ä¹ˆé€‰æ‹© Cross-Encoder Rerankerï¼Ÿ

| æ–¹æ³• | å‡†ç¡®ç‡ | é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|
| Bi-Encoder | ä¸€èˆ¬ | å¿« | åˆå§‹æ£€ç´¢ (Top-1000) |
| Cross-Encoder | é«˜ | æ…¢ | é‡æ’åº (Top-20 â†’ Top-5) |

Cross-Encoder é€šè¿‡è”åˆç¼–ç  Query å’Œ Documentï¼Œèƒ½æ•æ‰æ›´ç»†ç²’åº¦çš„è¯­ä¹‰äº¤äº’ï¼Œä½†è®¡ç®—æˆæœ¬é«˜ï¼Œé€‚åˆå¯¹å°‘é‡å€™é€‰è¿›è¡Œç²¾æ’ã€‚

---

## æœªæ¥æ”¹è¿›æ–¹å‘

| æ–¹å‘ | è¯´æ˜ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| **è·¨è¯­è¨€æ£€ç´¢** | ä¸­æ–‡æŸ¥è¯¢ â†’ è‹±æ–‡è®ºæ–‡ | â­â­ | âœ… å·²å®ç° |
| **Query æ‰©å±•** | ä½¿ç”¨ LLM æ‰©å±•/æ”¹å†™æŸ¥è¯¢ | â­â­ | å¾…å®ç° |
| **HyDE** | å…ˆç”Ÿæˆå‡è®¾ç­”æ¡ˆå†æ£€ç´¢ | â­â­ | å¾…å®ç° |
| **å¤šå‘é‡å¬å›** | å°† Query æ‹†åˆ†ä¸ºå­é—®é¢˜ | â­â­â­ | å¾…å®ç° |
| **ColBERT** | Token çº§ç»†ç²’åº¦åŒ¹é… | â­â­â­ | å¾…å®ç° |
| **Self-RAG** | è‡ªé€‚åº”æ£€ç´¢å†³ç­– | â­â­â­ | å¾…å®ç° |

---

## ä¾èµ–æ¸…å•

```
# å‘é‡æ•°æ®åº“
pymilvus==2.4.9

# Embedding
openai==1.58.1

# BM25
rank-bm25==0.2.2
jieba==0.42.1

# Reranker
sentence-transformers>=2.2.0
torch>=2.0.0

# PDF å¤„ç†
pdfplumber==0.11.4
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.2 (Structured Indexing + Recursive Semantic Chunking + Hybrid Search + Reranker + Cross-lingual)  
**æ›´æ–°æ—¥æœŸï¼š** 2026-01-29

